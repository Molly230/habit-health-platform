# 🚀 一键部署完整指南

## 📋 准备工作清单

### ✅ 服务器信息
- **IP地址**: `47.97.0.35`
- **用户**: `root`
- **项目路径**: `/var/www/habit`
- **配置**: 2vCPU/2GiB 阿里云轻量服务器

### ✅ 本地环境检查
- [ ] Git 已安装
- [ ] SSH 已安装（Git Bash 或 OpenSSH）
- [ ] 项目代码已提交到 Git 仓库

## 🚀 部署步骤

### 第1步：服务器初始化（只需运行一次）

```bash
# 1. 登录服务器
ssh root@47.97.0.35

# 2. 下载并运行初始化脚本
curl -o init-server.sh https://your-domain.com/init-server.sh
chmod +x init-server.sh
./init-server.sh

# 或者手动上传 init-server.sh 到服务器并执行
```

### 第2步：配置SSH密钥（只需配置一次）

```bash
# 在本地运行（Git Bash）
ssh-keygen -t rsa -b 4096 -C "your-email@example.com"
ssh-copy-id root@47.97.0.35

# 测试连接
ssh root@47.97.0.35 "echo 'SSH配置成功!'"
```

### 第3步：上传部署脚本到服务器

```bash
# 在本地项目目录运行
scp update.sh root@47.97.0.35:/var/www/habit/
scp restart.sh root@47.97.0.35:/var/www/habit/

# 设置可执行权限
ssh root@47.97.0.35 "chmod +x /var/www/habit/*.sh"
```

### 第4步：一键部署！

```bash
# 双击运行或在命令行执行
deploy.bat
```

## 🔄 日常部署流程

每次修改代码后，只需：

1. **保存代码** - 确保所有修改已保存
2. **运行部署** - 双击 `deploy.bat` 
3. **输入提交信息** - 或直接回车使用默认
4. **等待完成** - 自动推送代码并重启服务

## 📁 部署脚本说明

### 📄 本地脚本
- **`deploy.bat`** - 主部署脚本，一键部署
- **`SSH配置指南.md`** - SSH密钥配置教程

### 📄 服务器脚本  
- **`init-server.sh`** - 服务器初始化（只运行一次）
- **`update.sh`** - 代码更新和依赖安装
- **`restart.sh`** - 服务重启
- **`docker-deploy.sh`** - Docker部署（可选）

## 🎯 部署流程图

```
本地修改代码
    ↓
运行 deploy.bat
    ↓
提交 & 推送代码
    ↓
连接服务器
    ↓
拉取最新代码
    ↓
执行 update.sh
    ├── 安装依赖
    ├── 构建前端
    └── 更新数据库
    ↓
执行 restart.sh
    ├── 停止旧服务
    └── 启动新服务
    ↓
✅ 部署完成！
```

## 🔍 验证部署

部署完成后，访问以下地址验证：

- **🌐 前端**: `http://47.97.0.35/`
- **🔧 后端API**: `http://47.97.0.35:10000/api/health`
- **📊 诊断功能**: `http://47.97.0.35/diagnosis`

## 🛠️ 故障排除

### 常见问题1: SSH连接失败
```bash
# 检查SSH密钥
ssh -v root@47.97.0.35

# 重新配置密钥
ssh-copy-id root@47.97.0.35
```

### 常见问题2: 服务启动失败
```bash
# 登录服务器检查日志
ssh root@47.97.0.35
cd /var/www/habit
tail -f logs/backend.log

# 手动重启服务
./restart.sh
```

### 常见问题3: 端口被占用
```bash
# 查看端口占用
netstat -tuln | grep :10000

# 杀掉占用进程
fuser -k 10000/tcp
```

## 📈 高级功能

### 自动备份
每次部署前会自动备份当前版本到 `/var/www/backups/`

### 回滚功能
```bash
# 如果需要回滚到之前版本
ssh root@47.97.0.35
cd /var/www/backups
ls -la  # 查看备份列表
cp -r backup-YYYYMMDD-HHMMSS/* /var/www/habit/
cd /var/www/habit && ./restart.sh
```

### 日志监控
```bash
# 实时查看后端日志
ssh root@47.97.0.35
tail -f /var/www/habit/logs/backend.log

# 查看Nginx日志
tail -f /var/log/nginx/access.log
```

## 🎉 部署成功！

恭喜！你现在有了一个完整的一键部署系统：

- ⚡ **快速**: 一个命令完成部署
- 🔒 **安全**: SSH密钥认证
- 📦 **自动**: 自动备份和依赖管理  
- 🔄 **可靠**: 失败自动回滚
- 📊 **监控**: 完整的日志系统

每次修改代码后，只需双击 `deploy.bat`，几分钟后就能看到线上更新！