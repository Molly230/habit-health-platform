# 企业微信中医分身配置指南

## 🎯 企业微信的优势

✅ **完全合规** - 官方支持，不会封号  
✅ **功能强大** - 支持API、机器人、应用  
✅ **免费使用** - 基础功能完全免费  
✅ **易于管理** - 可添加外部联系人（患者）

## 📋 配置步骤

### 1. 注册企业微信
1. 访问 https://work.weixin.qq.com/
2. 注册企业账号（可用个人身份注册）
3. 完成企业认证（可选，影响部分功能）

### 2. 创建应用
1. 登录企业微信管理后台
2. 应用管理 → 自建 → 创建应用
3. 应用名称：`失眠中医分身`
4. 应用介绍：`智能失眠诊疗助手`
5. 可见范围：选择需要使用的成员

### 3. 获取配置信息
创建应用后，获取以下信息：
- **企业ID (CorpId)**：我的企业 → 企业信息
- **应用Secret (CorpSecret)**：应用详情页面
- **应用ID (AgentId)**：应用详情页面

### 4. 配置环境变量
编辑 `.env` 文件：
```bash
# 企业微信配置
WORK_WECHAT_CORP_ID=你的企业ID
WORK_WECHAT_CORP_SECRET=你的应用Secret
WORK_WECHAT_AGENT_ID=你的应用ID
WORK_WECHAT_TOKEN=随机字符串(如:tcmBot2024)
WORK_WECHAT_ENCODING_AES_KEY=可选的加密密钥
```

### 5. 设置接收消息
1. 应用详情 → 接收消息 → 设置API接收
2. URL：`https://你的域名/api/work_wechat`
3. Token：与.env中WORK_WECHAT_TOKEN一致
4. EncodingAESKey：可随机生成或留空

## 🚀 启动服务

### 安装依赖
```bash
pip install -r requirements.txt
```

### 启动Redis
```bash
redis-server
```

### 启动应用
```bash
python run.py
```

### 验证配置
访问企业微信管理后台，点击"保存"验证URL

## 📱 使用方式

### 内部成员使用
1. 在企业微信中找到"失眠中医分身"应用
2. 点击进入，开始对话
3. 发送"开始问诊"开始19题问诊

### 外部联系人使用
1. 通讯录 → 添加成员 → 邀请外部联系人
2. 设置应用可见性包含外部联系人
3. 外部联系人可以在企业微信中使用

## 🔧 测试功能

### 发送测试消息
```bash
curl -X POST http://localhost:5000/api/work_wechat/send_test \
  -H "Content-Type: application/json" \
  -d '{"userid":"你的userid","message":"测试消息"}'
```

### 常用指令
- `开始问诊` - 开始19题失眠问诊
- `查看报告` - 查看诊断结果
- `重新问诊` - 重新开始问诊
- `帮助` - 查看使用说明

## 🎨 功能特色

### 智能对话
- 专业的中医失眠咨询
- 19题结构化问诊
- 个性化治疗建议

### 会话管理
- 记录问诊进度
- 支持中途暂停和恢复
- 多用户并发支持

### 消息类型
- 文本消息
- Markdown格式消息
- 卡片消息

## ⚠️ 注意事项

1. **网络要求**：需要公网IP和域名
2. **HTTPS**：企业微信要求使用HTTPS
3. **权限管理**：合理设置应用可见范围
4. **数据安全**：妥善保管Secret等敏感信息

## 🔄 进阶配置

### 自定义菜单
可在应用详情中设置工作台应用主页，添加快捷菜单

### 群聊机器人
支持在群聊中@机器人进行问诊

### 消息推送
可主动向用户推送提醒消息

---

🎉 **恭喜！你的企业微信中医分身已经配置完成！**

用户可以在企业微信中直接与你的AI分身对话，完成专业的失眠问诊和治疗建议获取。