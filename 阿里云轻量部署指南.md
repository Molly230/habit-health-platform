# 阿里云轻量服务器部署指南

## 🚀 一键部署

### 前提条件
1. **阿里云轻量服务器**（推荐配置：2核2G，系统盘40G+）
2. **系统**：Ubuntu 20.04+ 或 CentOS 7+
3. **本地环境**：安装了Git、Node.js、SSH

### Step 1: 配置SSH密钥（重要！）

```bash
# 1. 生成SSH密钥（如果还没有）
ssh-keygen -t rsa -b 4096 -C "your-email@example.com"

# 2. 复制公钥到服务器
ssh-copy-id root@你的服务器IP

# 3. 测试连接
ssh root@你的服务器IP
```

### Step 2: 一键部署

```bash
# 设置服务器IP并部署
SERVER_IP=你的服务器IP ./deploy-aliyun-light.sh

# 或者直接修改脚本中的IP地址后运行
./deploy-aliyun-light.sh
```

## 📋 部署流程详解

### 自动完成的操作：
1. ✅ **代码准备**：自动提交本地变更
2. ✅ **前端构建**：npm build生成dist目录  
3. ✅ **服务器检查**：检查Docker环境，自动安装缺失组件
4. ✅ **代码同步**：rsync高效同步到服务器
5. ✅ **服务部署**：Docker Compose启动所有服务
6. ✅ **健康检查**：验证前后端服务状态

### 服务端口：
- **前端**：80端口
- **后端API**：10000端口  
- **Nginx健康检查**：/health

## 🔧 高级配置

### 域名配置
如果你有域名，修改以下配置：

```bash
# 1. 设置域名环境变量
DOMAIN=yourdomain.com SERVER_IP=你的IP ./deploy-aliyun-light.sh

# 2. 修改nginx配置中的server_name
# nginx.conf: server_name yourdomain.com;
```

### SSL证书配置
```bash
# 方案一：阿里云免费SSL证书（推荐）
# 1. 阿里云控制台申请SSL证书
# 2. 下载nginx格式证书
# 3. 上传到服务器/etc/nginx/ssl/

# 方案二：Let's Encrypt自动证书
ssh root@你的服务器IP
apt install certbot python3-certbot-nginx
certbot --nginx -d yourdomain.com
```

## 🛠️ 运维管理

### 常用命令
```bash
# SSH连接服务器
ssh root@你的服务器IP

# 进入项目目录
cd /var/www/habit

# 查看服务状态
docker-compose ps

# 查看实时日志
docker-compose logs -f

# 重启服务
docker-compose restart

# 停止服务
docker-compose down

# 完全重新构建
docker-compose down
docker-compose up -d --build
```

### 监控检查
```bash
# 检查服务健康
curl http://你的服务器IP/health
curl http://你的服务器IP:10000/api/health

# 查看服务器资源
htop
df -h
free -h

# 查看Docker资源
docker stats
```

## 🚨 故障排除

### 问题1：无法连接服务器
```bash
# 检查防火墙设置
ufw status
# 开放必要端口
ufw allow 22    # SSH
ufw allow 80    # HTTP  
ufw allow 443   # HTTPS
ufw allow 10000 # API
```

### 问题2：Docker服务启动失败
```bash
# 查看详细日志
docker-compose logs backend
docker-compose logs frontend

# 检查端口占用
netstat -tlnp | grep :80
netstat -tlnp | grep :10000

# 重置Docker
docker system prune -a
```

### 问题3：前端页面空白
```bash
# 检查构建产物
ls -la dist/

# 检查nginx配置
nginx -t

# 重新构建前端
npm run build
docker-compose restart frontend
```

## 💡 性能优化建议

### 轻量服务器优化：
1. **开启Gzip压缩**：已在nginx.conf中配置
2. **静态资源缓存**：已配置1年缓存
3. **数据库优化**：考虑使用阿里云RDS
4. **CDN加速**：接入阿里云CDN

### 监控告警：
```bash
# 安装监控工具
apt install htop iotop nethogs

# 设置定时任务检查服务
crontab -e
# 添加：*/5 * * * * curl -f http://localhost/health || systemctl restart docker
```

## 🎯 成功部署验证清单

- [ ] 前端首页正常访问：http://你的IP
- [ ] 后端API健康检查：http://你的IP:10000/api/health
- [ ] 诊断功能正常：可以完成19题问卷
- [ ] 数据保存正常：后端数据库有记录
- [ ] 购物车功能：添加商品正常
- [ ] 响应式设计：手机访问正常

## 🔄 日常维护

### 更新代码：
```bash
# 本地修改代码后
git add .
git commit -m "更新功能"
git push

# 服务器更新（方法一：重新部署）
SERVER_IP=你的IP ./deploy-aliyun-light.sh

# 服务器更新（方法二：手动）
ssh root@你的IP
cd /var/www/habit
git pull
docker-compose up -d --build
```

### 数据备份：
```bash
# 备份数据库
docker exec habit-backend cp /app/instance/insomnia_diagnosis.db /app/backup/
```

---

**部署成功后访问：**
- 🌐 前端：http://你的服务器IP  
- 🔧 API：http://你的服务器IP:10000/api/health
- 📱 手机端：同样地址，自适应响应式设计

**有问题加我微信：** `你的微信号`